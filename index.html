<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>UPA Summer Championship ‚Äì Live Draft Board</title>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      background: #000; 
      color: #fff; 
      margin: 0; 
      padding: 0; 
      font-size: 20px; 
    }
    header { 
      background: #B6094B; 
      padding: 1rem; 
      text-align: center; 
    }
    .draft-container { 
      max-width: 1600px; 
      margin: auto; 
      padding: 2rem; 
    }
    .on-the-clock { 
      background: #1E2132; 
      padding: 2rem; 
      border-radius: 20px; 
      text-align: center; 
      margin-bottom: 2rem; 
    }
    .on-the-clock h1 { 
      font-size: 2.5rem; 
      margin: 0.5rem 0; 
    }
    .timer { 
      font-size: 3rem; 
      color: #F2F4F5; 
      margin-top: 0.5rem; 
    }
    .logo-inline { 
      height: 40px; 
      vertical-align: middle; 
      margin-right: 10px; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 1rem; 
      font-size: 1.4rem; 
    }
    th, td { 
      padding: 1rem; 
      border: 1px solid #444; 
      text-align: left; 
      vertical-align: top; 
    }
    th { 
      background: #B6094B; 
    }
    .round-header { 
      font-size: 1.8rem; 
      font-weight: bold; 
      margin: 2.5rem 0 1rem; 
      border-bottom: 3px solid #B6094B; 
      padding-bottom: 0.3rem; 
    }
    .footer { 
      text-align: center; 
      margin-top: 4rem; 
      font-size: 1rem; 
      color: #999; 
    }
    .control-panel { 
      text-align: center; 
      margin-top: 1rem; 
    }
    input[type="text"] { 
      padding: 0.5rem; 
      margin: 0.5rem; 
      font-size: 1.2rem; 
      width: 45%; 
    }
    button { 
      padding: 0.6rem 1.2rem; 
      margin: 0.5rem; 
      background-color: #B6094B; 
      border: none; 
      color: white; 
      font-size: 1rem; 
      cursor: pointer; 
    }
    button:hover { 
      background-color: #000; 
    }
    #countdownOverlay { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0, 0, 0, 0.95); 
      color: #fff; 
      font-size: 30rem; 
      font-weight: bold; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 999; 
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .visible {
      opacity: 1;
    }
    .event-selector {
      padding: 8px 12px;
      margin-right: 10px;
      border: 1px solid #444;
      border-radius: 4px;
      background-color: #2d2d2d;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .event-selector:focus {
      outline: none;
      border-color: #646cff;
      box-shadow: 0 0 0 2px rgba(100, 108, 255, 0.2);
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .controls > div {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

<header>
  <h1>üèÄ UPA Summer Championship - Live Draft Board</h1>
  <p>üí∞ $15,000 Prize Pool ‚Ä¢ üìÖ Live Draft - July 18</p>
</header>

<div class="draft-container">
  <div class="on-the-clock" id="clock-box">
    <h1>On the Clock: <span id="currentTeam">-</span></h1>
    <div class="timer" id="timer">02:00</div>
  </div>

  <div class="control-panel">
    <div class="controls">
      <div>
        <select id="eventSelector" class="event-selector">
          <option value="1">UPA Summer Championship</option>
          <option value="2">Other Event</option>
        </select>
        <input type="text" id="playerInput" placeholder="Enter drafted player name...">
        <input type="text" id="tradeNoteInput" placeholder="Trade note (optional)">
        <button onclick="submitPick()">Submit Pick</button>
      </div>
      <div>
        <button id="startButton" onclick="startDraft()">Start Draft</button>
        <button onclick="pauseDraft()">Pause</button>
        <button onclick="resumeDraft()">Resume</button>
        <button onclick="toggleTraded()">Toggle Traded</button>
      </div>
    </div>
  </div>

  <div id="roundTables"></div>
</div>

<div class="footer">Powered by Unified Pro-Am ‚Ä¢ Road to $25K</div>

<div id="countdownOverlay">3</div>
<audio id="buzzer" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // Initialize Supabase
  const supabase = createClient(
    'https://suqhwtwfvpcyvcbnycsa.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1cWh3dHdmdnBjeXZjYm55Y3NhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0Mzk2MzAsImV4cCI6MjA2NzAxNTYzMH0.ROawOqve1AezL2Asi0MqcWy4GbISImG_CNbaXxNg2lo'
  );

  // Team data
  const baseTeams = [
    "Liquid Pro Am", "On Site", "Zero Tolerance", "Bodega Cats",
    "High Octane", "Lights Out", "Coatesville", "Before The Fame",
    "Hitlist", "Achieve Greatness", "Nobody Plays Harder", "Team 12",
    "Team 13", "Team 14", "Team 15", "Team 16",
    "Team 17", "Team 18", "Team 19", "Team 20",
    "Team 21", "Team 22", "Team 23", "Team 24",
    "Team 25", "Team 26", "Team 27", "Team 28",
    "Team 29", "Team 30", "Team 31", "Team 32"
  ];

  // Initialize draft data
  const picks = [];
  const totalRounds = 6;
  let currentPickIndex = 0;
  let timeLeft = 120;
  let timerPaused = false;
  let draftStarted = false;
  let timerInterval;
  let syntheticId = 1;

  // Generate draft order
  for (let round = 1; round <= totalRounds; round++) {
    const order = round % 2 === 0 ? [...baseTeams].reverse() : [...baseTeams];
    order.forEach(team => {
      picks.push({
        id: syntheticId++,
        pick: picks.length + 1,
        round,
        team,
        player: "",
        traded: false,
        trade_note: ""
      });
    });
  }

  // Initialize the draft board
  function initializeDraft() {
    updateDraftBoard();
    document.getElementById('currentTeam').textContent = picks[0]?.team || 'Team 1';
  }

  // Update the draft board display
  function updateDraftBoard() {
    const container = document.getElementById("roundTables");
    if (!container) return;
    
    container.innerHTML = "";
    
    for (let round = 1; round <= totalRounds; round++) {
      const roundPicks = picks.filter(p => p.round === round);
      let html = `<div class="round-header">Round ${round}</div>`;
      html += `<table><thead><tr><th>Pick #</th><th>Team</th><th>Player Drafted</th></tr></thead><tbody>`;
      
      roundPicks.forEach((p) => {
        const isCurrent = picks[currentPickIndex]?.pick === p.pick;
        const highlight = isCurrent ? 'style="background: #333;"' : '';
        
        html += `
          <tr ${highlight}>
            <td>#${p.pick}</td>
            <td>${getLogo(p.team)} ${p.team} ${p.traded ? 'üîÅ' : ''}</td>
            <td>
              ${p.player || "‚Äî"}
              ${p.traded ? '<span style="color:#fcb900"> (Traded)</span>' : ''}
              ${p.trade_note ? `<br><small style="color:#aaa;">üîÅ ${p.trade_note}</small>` : ''}
            </td>
          </tr>
        `;
      });
      
      html += `</tbody></table>`;
      container.innerHTML += html;
    }
    
    scrollToCurrentPick();
  }

  // Get team logo
  function getLogo(team) {
    // Handle numbered teams
    if (/^team\s*\d+$/i.test(team)) {
      return `<img src="./logos/placeholder.png" class="logo-inline" alt="${team} logo">`;
    }
    
    const file = team.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    return `<img src="./logos/${file}.png" class="logo-inline" alt="${team} logo" onerror="this.onerror=null; this.src='./logos/placeholder.png'">`;
  }

  // Scroll to current pick
  function scrollToCurrentPick() {
    const rows = document.querySelectorAll("#roundTables tr");
    if (rows[currentPickIndex]) {
      rows[currentPickIndex].scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }

  // Start the draft with countdown
  function startDraft() {
    const countdownOverlay = document.getElementById('countdownOverlay');
    const startButton = document.getElementById('startButton');
    
    if (!countdownOverlay) return;
    
    // Show countdown overlay
    countdownOverlay.textContent = '3';
    countdownOverlay.classList.add('visible');
    startButton.disabled = true;
    
    let count = 3;
    const countdownInterval = setInterval(() => {
      count--;
      
      if (count > 0) {
        countdownOverlay.textContent = count;
      } else {
        // End of countdown
        clearInterval(countdownInterval);
        countdownOverlay.classList.remove('visible');
        startButton.disabled = false;
        
        // Start the draft
        draftStarted = true;
        timeLeft = 120;
        updateClock();
        
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateClock, 1000);
      }
    }, 1000);
  }

  // Update the timer display
  function updateClock() {
    if (timerPaused || !draftStarted) return;
    
    const timerDisplay = document.getElementById('timer');
    const currentTeamDisplay = document.getElementById('currentTeam');
    
    if (!timerDisplay || !currentTeamDisplay) return;
    
    // Update timer display
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
      // Time's up - auto-pick if needed
      clearInterval(timerInterval);
      document.getElementById('buzzer').play();
      
      // Move to next pick if available
      if (currentPickIndex < picks.length - 1) {
        currentPickIndex++;
        timeLeft = 120;
        currentTeamDisplay.textContent = picks[currentPickIndex]?.team || 'Team ' + (currentPickIndex + 1);
        updateDraftBoard();
        timerInterval = setInterval(updateClock, 1000);
      } else {
        // Draft complete
        currentTeamDisplay.textContent = "Draft Complete";
        draftStarted = false;
      }
    } else {
      timeLeft--;
    }
  }

  // Submit a pick
  async function submitPick() {
    const input = document.getElementById("playerInput");
    const noteInput = document.getElementById("tradeNoteInput");
    const eventSelector = document.getElementById("eventSelector");
    
    const name = input.value.trim();
    const note = noteInput.value.trim();
    const eventId = parseInt(eventSelector.value, 10) || 1;

    if (!name || currentPickIndex >= picks.length) return;

    const pick = picks[currentPickIndex];
    if (!pick || !pick.id) {
      console.error("Invalid pick or missing ID:", pick);
      alert("Error: Could not find pick data. Please refresh the page and try again.");
      return;
    }
    
    try {
      // Update in Supabase
      const { error } = await supabase
        .from('draft_picks')
        .update({
          selected_player_id: name,
          trade_note: note || null,
          pick: pick.pick,
          round: pick.round,
          team: pick.team,
          player: name,
          event_id: eventId
        })
        .eq('id', pick.id);

      if (error) throw error;

      // Update local state
      pick.player = name;
      pick.trade_note = note;
      pick.event_id = eventId;
      
      // Clear inputs
      input.value = "";
      noteInput.value = "";
      
      // Move to next pick
      if (currentPickIndex < picks.length - 1) {
        currentPickIndex++;
        timeLeft = 120;
        document.getElementById('currentTeam').textContent = picks[currentPickIndex]?.team || 'Team ' + (currentPickIndex + 1);
      } else {
        // Draft complete
        document.getElementById('currentTeam').textContent = "Draft Complete";
        draftStarted = false;
        if (timerInterval) clearInterval(timerInterval);
      }
      
      updateDraftBoard();
      
    } catch (error) {
      console.error("Error updating pick:", error);
      alert("Failed to save pick: " + (error.message || 'Unknown error'));
    }
  }

  // Toggle traded status for current pick
  function toggleTraded() {
    if (currentPickIndex >= picks.length) return;
    picks[currentPickIndex].traded = !picks[currentPickIndex].traded;
    updateDraftBoard();
  }

  // Pause the draft timer
  function pauseDraft() {
    if (!draftStarted) return;
    timerPaused = true;
  }

  // Resume the draft timer
  function resumeDraft() {
    if (!draftStarted) return;
    timerPaused = false;
  }

  // Initialize when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    initializeDraft();
  });

  // Make functions available globally
  window.submitPick = submitPick;
  window.pauseDraft = pauseDraft;
  window.resumeDraft = resumeDraft;
  window.startDraft = startDraft;
  window.toggleTraded = toggleTraded;
</script>

</body>
</html>